<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SignalWire">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" id="themeColor" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SignalWire">
    
    <title>SignalWire · Сигнальный кабель</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ========== */
        :root {
            --primary: #0088cc;
            --primary-dark: #0077b3;
            --bg-dark: #000000;
            --bg-sidebar: #111111;
            --bg-card: #1a1a1a;
            --bg-input: #222222;
            --border: #333333;
            --text: #ffffff;
            --text-secondary: #aaaaaa;
            --text-muted: #777777;
            --success: #00b894;
            --danger: #ff4444;
            --danger-dark: #ff0000;
            --online: #00ff00;
            --admin: #ffaa00;
            --channel: #00b894;
            --channel-dark: #00a884;
            --news: #8e44ad;
            --shadow: 0 8px 20px rgba(0,0,0,0.5);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* ========== СВЕТЛАЯ ТЕМА ========== */
        body.light-theme {
            --bg-dark: #f0f2f5;
            --bg-sidebar: #ffffff;
            --bg-card: #f5f5f5;
            --bg-input: #ffffff;
            --border: #e0e0e0;
            --text: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            background: var(--bg-dark);
        }

        body.light-theme .chat-item {
            background: #ffffff;
        }
        
        body.light-theme .chat-item:hover {
            background: #f5f5f5;
        }
        
        body.light-theme .chat-item.active {
            background: #e8f0fe;
        }

        /* ========== ПЛАВНЫЕ АНИМАЦИИ ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* ========== ПЛАВНЫЕ УВЕДОМЛЕНИЯ ========== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            border-left: 6px solid var(--primary);
            border-radius: var(--radius-md);
            display: none;
            z-index: 10001;
            max-width: 400px;
            margin: 0 auto;
            animation: slideDown 0.3s ease;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        @media (min-width: 768px) {
            .notification {
                left: auto;
                right: 20px;
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            gap: 14px;
        }

        .notification-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--primary);
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notification-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-close:hover {
            background: var(--danger);
            color: white;
        }

        .notification.success {
            border-left-color: var(--success);
        }
        .notification.success .notification-icon {
            background: var(--success);
        }
        .notification.success .notification-title {
            color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }
        .notification.error .notification-icon {
            background: var(--danger);
        }
        .notification.error .notification-title {
            color: var(--danger);
        }

        .notification.news {
            border-left-color: var(--news);
        }
        .notification.news .notification-icon {
            background: var(--news);
        }
        .notification.news .notification-title {
            color: var(--news);
        }

        .notification.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* ========== СТИКЕРЫ ========== */
        .sticker-panel {
            position: absolute;
            bottom: 80px;
            left: 12px;
            right: 12px;
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            display: none;
            z-index: 1000;
            animation: slideUp 0.2s ease;
            box-shadow: var(--shadow);
        }

        .sticker-panel.visible {
            display: block;
        }

        .sticker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .sticker-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .sticker-close:hover {
            background: var(--danger);
            color: white;
        }

        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        .sticker-item {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sticker-item:hover {
            background: var(--bg-card);
            transform: scale(1.05);
            border-color: var(--primary);
        }

        /* ========== ОКНО АВТОРИЗАЦИИ ========== */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }

        .auth-box {
            background: var(--bg-sidebar);
            padding: 32px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 440px;
            animation: scaleIn 0.3s ease;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-title h2 {
            font-size: 32px;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .auth-title i {
            font-size: 36px;
        }

        .anonymity-badge {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 24px;
        }

        .anonymity-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
        }

        .auth-form {
            display: block;
        }

        .auth-form.hidden {
            display: none;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .auth-button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .auth-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .username-check {
            margin-top: 4px;
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--text-muted);
            padding-left: 4px;
        }

        /* ========== САЙДБАР ========== */
        .sidebar {
            width: 100%;
            max-width: 380px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.visible {
            transform: translateX(0);
        }

        @media (min-width: 768px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        .logo i {
            font-size: 28px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .news-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            position: relative;
        }

        .news-btn:hover {
            background: var(--news);
            color: white;
        }

        .news-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .settings-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* ========== КАРТОЧКА ПОЛЬЗОВАТЕЛЯ ========== */
        .user-card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            animation: slideIn 0.3s ease;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
            min-width: 0;
        }

        .user-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-details {
            min-width: 0;
            flex: 1;
        }

        .user-details h4 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }

        .user-details p {
            font-size: 13px;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--admin);
            border-radius: 100px;
            font-size: 10px;
            font-weight: 700;
            color: black;
            flex-shrink: 0;
        }

        .anonymous-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 10px;
            color: var(--primary);
            flex-shrink: 0;
        }

        /* ========== КАНАЛЫ - ПОЛНОСТЬЮ БЕЗ ГОРИЗОНТАЛЬНОГО СКРОЛЛА! ========== */
        .channels-section {
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            animation: slideIn 0.3s ease;
            width: 100%;
            overflow: hidden;
        }

        .channels-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .channels-title h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--channel);
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .create-channel-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .create-channel-btn:hover {
            background: var(--channel);
            color: white;
            transform: scale(1.05);
        }

        .channels-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            padding-right: 4px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-left: 4px solid var(--channel);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            animation: slideIn 0.3s ease;
            width: 100%;
            min-width: 0;
        }

        .channel-item:hover {
            background: var(--bg-card);
            transform: translateX(5px);
        }

        .channel-item.active {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
        }

        .channel-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .channel-avatar:hover {
            transform: scale(1.05);
        }

        .channel-info {
            flex: 1;
            min-width: 0;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-name span {
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--channel);
            color: white;
            flex-shrink: 0;
        }

        .channel-meta {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-creator {
            color: var(--channel);
        }

        /* ========== ПОИСК КАНАЛОВ ========== */
        .channel-search-section {
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            animation: slideIn 0.3s ease;
            width: 100%;
            overflow: hidden;
        }

        .channel-search-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--channel);
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-search-box {
            position: relative;
            width: 100%;
        }

        .channel-search-box input {
            width: 100%;
            padding: 14px 14px 14px 48px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .channel-search-box input:focus {
            border-color: var(--channel);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,184,148,0.1);
        }

        .channel-search-box i {
            position: absolute;
            left: 18px;
            top: 14px;
            color: var(--text-muted);
            font-size: 18px;
            transition: color 0.2s;
        }

        .channel-search-box input:focus + i {
            color: var(--channel);
        }

        .channel-search-results {
            margin-top: 12px;
            max-height: 250px;
            overflow-y: auto;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            display: none;
            animation: scaleIn 0.2s ease;
            width: 100%;
        }

        .channel-search-results.visible {
            display: block;
        }

        .channel-search-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
            width: 100%;
        }

        .channel-search-item:hover {
            background: var(--bg-card);
            transform: translateX(5px);
        }

        .channel-search-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .channel-search-info {
            flex: 1;
            min-width: 0;
        }

        .channel-search-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-search-name span {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-search-creator {
            font-size: 11px;
            color: var(--channel);
        }

        .channel-search-description {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== СПИСОК ЧАТОВ - ПОЛНОСТЬЮ БЕЗ СКРОЛЛА! ========== */
        .chats-wrapper {
            flex: 1;
            overflow-y: hidden !important;
            padding: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .chats-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
            width: 100%;
        }

        .section-title {
            padding: 12px 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 0;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
            animation: slideIn 0.3s ease;
            width: 100%;
            background: var(--bg-sidebar);
        }

        .chat-item:hover {
            background: var(--bg-card);
            transform: translateX(5px);
        }

        .chat-item.active {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
        }

        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-right: 16px;
            position: relative;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .chat-avatar:hover {
            transform: scale(1.05);
        }

        .online-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid var(--bg-sidebar);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-name span {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-username {
            font-size: 12px;
            color: var(--primary);
            background: rgba(0,136,204,0.1);
            padding: 2px 8px;
            border-radius: 12px;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== CHANNEL MODAL ========== */
        .channel-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .channel-box {
            background: var(--bg-sidebar);
            padding: 28px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .channel-header h2 {
            color: var(--channel);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .channel-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            transition: transform 0.2s;
        }

        .channel-avatar-large:hover {
            transform: scale(1.05);
        }

        .channel-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }

        .channel-input:focus {
            border-color: var(--channel);
            outline: none;
        }

        .channel-textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 16px;
            min-height: 100px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .channel-textarea:focus {
            border-color: var(--channel);
            outline: none;
        }

        .channel-create-btn {
            width: 100%;
            padding: 16px;
            background: var(--channel);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .channel-create-btn:hover {
            background: var(--channel-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,184,148,0.3);
        }

        .channel-delete-btn {
            width: 100%;
            padding: 16px;
            background: var(--danger);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .channel-delete-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,68,68,0.3);
        }

        /* ========== CHANNEL PROFILE MODAL ========== */
        .channel-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .channel-profile-box {
            background: var(--bg-sidebar);
            padding: 28px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 450px;
            animation: scaleIn 0.3s ease;
        }

        .channel-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .channel-profile-header h2 {
            color: var(--channel);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto 20px;
            transition: transform 0.2s;
        }

        .channel-profile-avatar:hover {
            transform: scale(1.05);
        }

        .channel-profile-name {
            text-align: center;
            margin-bottom: 8px;
        }

        .channel-profile-name h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-profile-id {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(0,184,148,0.1);
            border: 1px solid var(--channel);
            border-radius: 100px;
            color: var(--channel);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .channel-profile-description {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-secondary);
            line-height: 1.6;
            word-wrap: break-word;
        }

        .channel-profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .channel-profile-stat {
            text-align: center;
            min-width: 0;
        }

        .channel-profile-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--channel);
            margin-bottom: 4px;
        }

        .channel-profile-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-profile-creator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .channel-profile-creator i {
            color: var(--admin);
        }

        .channel-profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .channel-profile-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            min-width: 120px;
        }

        .channel-profile-btn:hover {
            transform: translateY(-2px);
        }

        .channel-profile-join-btn {
            background: var(--channel);
            color: white;
        }

        .channel-profile-edit-btn {
            background: var(--primary);
            color: white;
        }

        .channel-profile-delete-btn {
            background: var(--danger);
            color: white;
        }

        .channel-profile-leave-btn {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .channel-profile-leave-btn:hover {
            background: var(--danger);
            color: white;
        }

        .channel-profile-block-btn {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .channel-profile-block-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* ========== ПОИСК ПОЛЬЗОВАТЕЛЕЙ ========== */
        .search-section {
            margin-top: 8px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            animation: slideIn 0.3s ease;
            width: 100%;
            overflow: hidden;
        }

        .search-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-box input {
            width: 100%;
            padding: 14px 14px 14px 48px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,136,204,0.1);
        }

        .search-box i {
            position: absolute;
            left: 18px;
            top: 14px;
            color: var(--text-muted);
            font-size: 18px;
            transition: color 0.2s;
        }

        .search-box input:focus + i {
            color: var(--primary);
        }

        .search-results {
            margin-top: 12px;
            max-height: 250px;
            overflow-y: auto;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            display: none;
            animation: scaleIn 0.2s ease;
            width: 100%;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: all 0.2s;
            width: 100%;
        }

        .search-result-item:hover {
            background: var(--bg-card);
            transform: translateX(5px);
        }

        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-name span {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-username {
            font-size: 11px;
            color: var(--primary);
            flex-shrink: 0;
        }

        .search-result-bio {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== ЧАТ ========== */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            position: relative;
            width: 100%;
            height: 100%;
        }

        .chat-header {
            padding: 12px 16px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
            width: 100%;
        }

        .chat-back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,136,204,0.3);
        }

        @media (min-width: 768px) {
            .chat-back-btn {
                display: none;
            }
        }

        .chat-user {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
            min-width: 0;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .chat-user:hover {
            background: var(--bg-card);
        }

        .chat-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            position: relative;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .chat-user-avatar:hover {
            transform: scale(1.05);
        }

        .channel-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .channel-avatar-large:hover {
            transform: scale(1.05);
        }

        .chat-user-info {
            min-width: 0;
            flex: 1;
        }

        .chat-user-info h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-user-username {
            font-size: 13px;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-tag {
            background: var(--channel);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            flex-shrink: 0;
        }

        .admin-tag {
            background: var(--admin);
            color: black;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .messages {
            flex: 1;
            padding: 20px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease;
            transition: all 0.2s;
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @media (min-width: 768px) {
            .message {
                max-width: 65%;
            }
        }

        .message.sent {
            background: var(--primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            color: white;
        }

        .message.received {
            background: var(--bg-card);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            color: var(--text);
        }

        .message.channel-message {
            background: var(--channel);
            color: white;
        }

        .message-sticker {
            font-size: 48px;
            text-align: center;
            line-height: 1;
            margin-bottom: 6px;
        }

        .message-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 6px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            text-align: right;
        }

        .message.received .message-time {
            color: var(--text-muted);
        }

        /* ========== ПАНЕЛЬ ВВОДА ========== */
        .input-area {
            padding: 12px 16px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            animation: slideUp 0.3s ease;
            width: 100%;
            position: relative;
        }

        .sticker-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .sticker-btn:hover {
            background: var(--bg-card);
            color: var(--primary);
        }

        .sticker-btn.active {
            background: var(--primary);
            color: white;
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 30px;
            color: var(--text);
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
            min-width: 0;
        }

        .message-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0,136,204,0.1);
        }

        .send-button {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,136,204,0.3);
        }

        .chat-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            animation: fadeIn 0.4s ease;
            width: 100%;
            height: 100%;
        }

        .chat-placeholder i {
            font-size: 80px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: float 3s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .chat-placeholder h2 {
            color: var(--text-muted);
            font-size: 24px;
            margin-bottom: 8px;
        }

        .chat-placeholder p {
            color: var(--text-muted);
            opacity: 0.7;
        }

        #chatActive {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* ========== USER PROFILE MODAL ========== */
        .user-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .user-profile-box {
            background: var(--bg-sidebar);
            padding: 28px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
            animation: scaleIn 0.3s ease;
        }

        .user-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .user-profile-header h2 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile-close {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .user-profile-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .user-profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            border: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .user-profile-avatar:hover {
            transform: scale(1.05);
        }

        .user-profile-name {
            text-align: center;
            margin-bottom: 8px;
        }

        .user-profile-name h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-profile-username {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(0,136,204,0.1);
            border: 1px solid var(--primary);
            border-radius: 100px;
            color: var(--primary);
            font-size: 15px;
            margin-bottom: 16px;
        }

        .user-profile-bio {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-secondary);
            line-height: 1.6;
            word-wrap: break-word;
        }

        .user-profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
        }

        .stat-item {
            text-align: center;
            min-width: 0;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-profile-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .status-online {
            color: var(--online);
        }

        .user-profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            flex: 1;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            min-width: 120px;
        }

        .profile-action-btn:hover {
            transform: translateY(-2px);
        }

        .message-btn {
            background: var(--primary);
            color: white;
        }

        .block-btn {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .block-btn:hover {
            background: var(--danger);
            color: white;
        }

        .delete-chat-btn {
            background: var(--danger);
            color: white;
        }

        /* ========== SETTINGS MODAL ========== */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .settings-box {
            background: var(--bg-sidebar);
            padding: 28px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .settings-header h2 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-label {
            display: block;
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-input,
        .settings-textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            transition: all 0.2s;
        }

        .settings-input:focus,
        .settings-textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,136,204,0.1);
        }

        .settings-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .avatar-option {
            aspect-ratio: 1;
            border-radius: 50%;
            background: var(--bg-input);
            border: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            border-color: var(--primary);
            background: var(--bg-card);
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 2px rgba(0,136,204,0.2);
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .color-option {
            aspect-ratio: 1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }

        .theme-switcher {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .theme-option {
            flex: 1;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .theme-option:hover {
            background: var(--bg-card);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .settings-save-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-top: 24px;
        }

        .settings-save-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,136,204,0.3);
        }

        .logout-settings-btn {
            width: 100%;
            padding: 16px;
            background: var(--danger);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .logout-settings-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,68,68,0.3);
        }

        /* ========== NEWS MODAL ========== */
        .news-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .news-box {
            background: var(--bg-sidebar);
            padding: 28px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .news-header h2 {
            color: var(--news);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .news-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--news);
            border-radius: var(--radius-md);
            padding: 20px;
            animation: slideIn 0.3s;
        }

        .news-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .news-item-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .news-item-date {
            font-size: 12px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .news-item-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .news-item-author {
            font-size: 13px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-news-form {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 24px;
        }

        .admin-news-form h3 {
            color: var(--admin);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-input {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 12px;
        }

        .news-input:focus {
            border-color: var(--admin);
            outline: none;
        }

        .news-textarea {
            width: 100%;
            padding: 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 12px;
            min-height: 120px;
            resize: vertical;
        }

        .news-textarea:focus {
            border-color: var(--admin);
            outline: none;
        }

        .news-send-btn {
            width: 100%;
            padding: 16px;
            background: var(--admin);
            border: none;
            border-radius: var(--radius-sm);
            color: black;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .news-send-btn:hover {
            background: #ff9900;
            transform: translateY(-2px);
        }

        /* ========== ADMIN PANEL ========== */
        .admin-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--admin);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 24px;
        }

        .admin-panel h3 {
            color: var(--admin);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .admin-stat-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }

        .admin-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--admin);
            margin-bottom: 4px;
        }

        .admin-stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .admin-users-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        .admin-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .admin-user-item:last-child {
            border-bottom: none;
        }

        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex: 1;
        }

        .admin-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .admin-user-details {
            min-width: 0;
            flex: 1;
        }

        .admin-user-name {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-user-username {
            font-size: 12px;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .admin-user-status.online {
            background: var(--online);
        }

        .admin-user-status.offline {
            background: var(--text-muted);
        }

        /* ========== СКРОЛЛБАР ========== */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-sidebar);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
            transition: all 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ========== УТИЛИТЫ ========== */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .app {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .chats-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- ========== ОКНО АВТОРИЗАЦИИ ========== -->
    <div class="auth-modal" id="authModal">
        <div class="auth-box">
            <div class="auth-title">
                <h2>
                    <i class="fas fa-plug"></i>
                    SignalWire
                </h2>
            </div>
            
            <div class="anonymity-badge">
                <div class="anonymity-title">
                    <i class="fas fa-shield-alt"></i>
                    <span>Сигнальный кабель</span>
                </div>
                <div style="color: var(--text-secondary); font-size: 14px; text-align: center;">
                    🔌 Каналы, стикеры и личные сообщения<br>
                    🕵️ Только никнейм и пароль<br>
                    📢 Поиск каналов по названию
                </div>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Вход</div>
                <div class="auth-tab" id="registerTab">Регистрация</div>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <input type="text" class="auth-input" id="loginUsername" placeholder="@никнейм">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Пароль">
                <button class="auth-button" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Подключиться
                </button>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form hidden" id="registerForm">
                <input type="text" class="auth-input" id="regName" placeholder="Имя">
                <input type="text" class="auth-input" id="regUsername" placeholder="Никнейм">
                <div class="username-check" id="usernameCheck">Введите никнейм (минимум 3 символа)</div>
                <input type="password" class="auth-input" id="regPassword" placeholder="Пароль">
                <input type="password" class="auth-input" id="regPasswordConfirm" placeholder="Повторите пароль">
                <input type="text" class="auth-input" id="regBio" placeholder="О себе (необязательно)">
                <button class="auth-button" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    Проложить кабель
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== СТИКЕРЫ ========== -->
    <div class="sticker-panel" id="stickerPanel">
        <div class="sticker-header">
            <h3 style="color: var(--primary);"><i class="fas fa-smile"></i> Стикеры</h3>
            <button class="sticker-close" id="closeStickerBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sticker-grid" id="stickerGrid"></div>
    </div>
    
    <!-- ========== CHANNEL CREATE MODAL ========== -->
    <div class="channel-modal" id="channelModal">
        <div class="channel-box">
            <div class="channel-header">
                <h2>
                    <i class="fas fa-bullhorn"></i>
                    Создать канал
                </h2>
                <button class="close-btn" id="closeChannelBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="channel-avatar-large" id="createChannelAvatar" style="background: var(--channel);">
                <i class="fas fa-bullhorn"></i>
            </div>
            
            <input type="text" class="channel-input" id="channelName" placeholder="Название канала">
            <textarea class="channel-textarea" id="channelDescription" placeholder="Описание канала (необязательно)"></textarea>
            
            <button class="channel-create-btn" id="createChannelBtn">
                <i class="fas fa-plus-circle"></i>
                Создать канал
            </button>
        </div>
    </div>
    
    <!-- ========== CHANNEL EDIT MODAL ========== -->
    <div class="channel-modal" id="channelEditModal">
        <div class="channel-box">
            <div class="channel-header">
                <h2>
                    <i class="fas fa-edit"></i>
                    Редактировать канал
                </h2>
                <button class="close-btn" id="closeChannelEditBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="channel-avatar-large" id="editChannelAvatar">
                <i class="fas fa-bullhorn"></i>
            </div>
            
            <input type="text" class="channel-input" id="editChannelName" placeholder="Название канала">
            <textarea class="channel-textarea" id="editChannelDescription" placeholder="Описание канала"></textarea>
            
            <button class="channel-create-btn" id="saveChannelEditBtn">
                <i class="fas fa-save"></i>
                Сохранить изменения
            </button>
            
            <button class="channel-delete-btn" id="deleteChannelBtn">
                <i class="fas fa-trash"></i>
                Удалить канал
            </button>
        </div>
    </div>
    
    <!-- ========== CHANNEL PROFILE MODAL ========== -->
    <div class="channel-profile-modal" id="channelProfileModal">
        <div class="channel-profile-box">
            <div class="channel-profile-header">
                <h2>
                    <i class="fas fa-bullhorn"></i>
                    Канал
                </h2>
                <button class="close-btn" id="closeChannelProfileBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="channelProfileContent"></div>
        </div>
    </div>
    
    <!-- ========== NEWS MODAL ========== -->
    <div class="news-modal" id="newsModal">
        <div class="news-box">
            <div class="news-header">
                <h2>
                    <i class="fas fa-broadcast-tower"></i>
                    Новости SignalWire
                </h2>
                <button class="close-btn" id="closeNewsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="newsContainer" class="news-list">
                <!-- News will be loaded here -->
            </div>
            
            <!-- Admin Panel - Visible only to @avgar -->
            <div id="adminPanel" class="admin-panel hidden">
                <h3>
                    <i class="fas fa-crown"></i>
                    Панель администратора
                </h3>
                
                <div class="admin-stats">
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="totalUsers">0</div>
                        <div class="admin-stat-label">пользователей</div>
                    </div>
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="onlineUsers">0</div>
                        <div class="admin-stat-label">онлайн</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text); font-weight: 600;">Активные пользователи</span>
                        <span style="color: var(--text-muted); font-size: 12px;">онлайн/всего</span>
                    </div>
                    <div class="admin-users-list" id="adminUsersList"></div>
                </div>
                
                <div class="admin-news-form">
                    <h3>
                        <i class="fas fa-newspaper"></i>
                        Создать новость
                    </h3>
                    <input type="text" class="news-input" id="newsTitle" placeholder="Заголовок новости">
                    <textarea class="news-textarea" id="newsContent" placeholder="Текст новости..."></textarea>
                    <button class="news-send-btn" id="publishNewsBtn">
                        <i class="fas fa-paper-plane"></i>
                        Опубликовать
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========== USER PROFILE MODAL ========== -->
    <div class="user-profile-modal" id="userProfileModal">
        <div class="user-profile-box">
            <div class="user-profile-header">
                <h2>
                    <i class="fas fa-user"></i>
                    Профиль
                </h2>
                <button class="user-profile-close" id="closeProfileBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="profileContent"></div>
        </div>
    </div>
    
    <!-- ========== NOTIFICATION ========== -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notificationIcon">
                <i class="fas fa-plug"></i>
            </div>
            <div class="notification-text">
                <div class="notification-title" id="notificationTitle">SignalWire</div>
                <div class="notification-message" id="notificationMessage"></div>
            </div>
            <button class="notification-close" onclick="closeNotification()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- ========== SETTINGS MODAL ========== -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-box">
            <div class="settings-header">
                <h2>
                    <i class="fas fa-cog"></i>
                    Настройки
                </h2>
                <button class="close-btn" id="closeSettingsBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Avatar Selection -->
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-face-smile"></i>
                    Аватар
                </label>
                <div class="avatar-selector" id="avatarSelector"></div>
            </div>
            
            <!-- Color Selection -->
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-palette"></i>
                    Цвет профиля
                </label>
                <div class="color-selector" id="colorSelector"></div>
            </div>
            
            <!-- Theme Selection -->
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-theater-masks"></i>
                    Тема оформления
                </label>
                <div class="theme-switcher">
                    <div class="theme-option active" id="darkThemeBtn">
                        <i class="fas fa-moon"></i>
                        Тёмная
                    </div>
                    <div class="theme-option" id="lightThemeBtn">
                        <i class="fas fa-sun"></i>
                        Светлая
                    </div>
                </div>
            </div>
            
            <!-- Profile Information -->
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-user"></i>
                    Имя
                </label>
                <input type="text" class="settings-input" id="settingsName" placeholder="Ваше имя">
            </div>
            
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-at"></i>
                    Никнейм
                </label>
                <input type="text" class="settings-input" id="settingsUsername" placeholder="@никнейм">
                <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> Уникальный идентификатор
                </p>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">
                    <i class="fas fa-info-circle"></i>
                    О себе
                </label>
                <textarea class="settings-textarea" id="settingsBio" placeholder="Расскажите о себе..." rows="3"></textarea>
            </div>
            
            <button class="settings-save-btn" id="saveSettingsBtn">
                <i class="fas fa-save"></i>
                Сохранить изменения
            </button>
            
            <button class="logout-settings-btn" id="logoutSettingsBtn">
                <i class="fas fa-sign-out-alt"></i>
                Отключиться
            </button>
        </div>
    </div>
    
    <!-- ========== MAIN APPLICATION ========== -->
    <div class="app" id="app">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-row">
                    <div class="logo">
                        <i class="fas fa-plug"></i>
                        <span>SignalWire</span>
                    </div>
                    <div class="header-buttons">
                        <button class="news-btn" id="openNewsBtn">
                            <i class="fas fa-broadcast-tower"></i>
                            <span class="news-badge hidden" id="newsBadge">1</span>
                        </button>
                        <button class="settings-btn" id="openSettingsBtnHeader">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- User Card -->
                <div class="user-card" id="userCard"></div>
                
                <!-- Мои каналы (подписки) -->
                <div class="channels-section">
                    <div class="channels-title">
                        <h3>
                            <i class="fas fa-bullhorn"></i>
                            Мои каналы
                        </h3>
                        <button class="create-channel-btn" id="openChannelBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="channels-list" id="myChannelsList"></div>
                </div>
                
                <!-- Поиск каналов -->
                <div class="channel-search-section">
                    <div class="channel-search-title">
                        <i class="fas fa-search"></i>
                        <span>Поиск каналов</span>
                    </div>
                    <div class="channel-search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="channelSearchInput" placeholder="Название канала">
                    </div>
                    <div class="channel-search-results" id="channelSearchResults"></div>
                </div>
                
                <!-- Поиск пользователей -->
                <div class="search-section">
                    <div class="search-title">
                        <i class="fas fa-search"></i>
                        <span>Поиск абонента</span>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="@никнейм или имя">
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
            
            <!-- Chats List - ПОЛНОСТЬЮ БЕЗ СКРОЛЛА! -->
            <div class="chats-wrapper">
                <div class="section-title">
                    <i class="fas fa-comments"></i>
                    Ваши подключения
                </div>
                <div class="chats-container" id="chatsContainer">
                    <!-- Чаты будут загружаться сюда -->
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-placeholder" id="chatPlaceholder">
                <i class="fas fa-plug"></i>
                <h2>Сигнальный кабель</h2>
                <p>🔌 Выберите чат или канал</p>
                <p style="margin-top: 12px;">😊 Нажмите на смайлик для стикеров</p>
                <p style="margin-top: 8px;">📢 Ищите каналы по названию</p>
            </div>
            
            <div style="display: none; flex-direction: column; height: 100%; width: 100%;" id="chatActive">
                <!-- Chat Header -->
                <div class="chat-header">
                    <button class="chat-back-btn" id="chatBackBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-user" id="currentChatUser"></div>
                </div>
                
                <!-- Messages -->
                <div class="messages" id="messagesContainer"></div>
                
                <!-- Input Area with Stickers -->
                <div class="input-area">
                    <button class="sticker-btn" id="stickerBtn">
                        <i class="far fa-smile"></i>
                    </button>
                    <input type="text" class="message-input" id="messageInput" placeholder="Сообщение...">
                    <button class="send-button" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ========== FIREBASE CONFIGURATION ==========
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyB7sFm26dXetYBdj42h3UO5EDym39nxEns",
            authDomain: "signalwire-b52e8.firebaseapp.com",
            databaseURL: "https://signalwire-b52e8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "signalwire-b52e8",
            storageBucket: "signalwire-b52e8.firebasestorage.app",
            messagingSenderId: "897606109522",
            appId: "1:897606109522:web:42ba031b9411e08b41928b"
        };

        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const database = firebase.database();
        
        // ========== APPLICATION STATE ==========
        const State = {
            currentUser: null,
            currentChatUser: null,
            currentChannel: null,
            currentEditingChannel: null,
            allUsers: {},
            onlineUsers: {},
            userChats: new Set(),
            subscribedChannels: new Set(),
            blockedUsers: new Set(),
            channels: {},
            news: [],
            messagesListener: null,
            userMessagesListener: null,
            channelMessagesListener: null,
            currentChatId: null,
            usernameCheckTimeout: null,
            searchTimeout: null,
            channelSearchTimeout: null
        };

        // ========== CONSTANTS ==========
        const ADMIN_USERNAME = 'avgar';
        const OFFICIAL_CHANNEL_ID = 'channel_signalwire_official';
        
        const AVATARS = [
            '👨', '👩', '🧑', '👨‍🦰', '👩‍🦰', '👨‍🦱', '👩‍🦱', 
            '👨‍🦲', '👩‍🦲', '👨‍🦳', '👩‍🦳', '🧔', '🧑‍🦰', 
            '👶', '🧒', '👧', '👦', '👴', '👵'
        ];

        const COLORS = [
            '#0088cc', '#2b5278', '#3a506b', '#5d5179', 
            '#4a6fa5', '#588157', '#9c27b0', '#e91e63',
            '#ff9800', '#4caf50', '#2196f3', '#f44336'
        ];

        const STICKERS = [
            '😊', '😂', '🥰', '😎', '🤔', '😴', '🥳', '😱',
            '👍', '👎', '👏', '🙏', '🔥', '✨', '⭐', '💯',
            '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍',
            '🐱', '🐶', '🐼', '🦊', '🐸', '🐨', '🦁', '🐧',
            '🍕', '🍔', '🌮', '🍣', '🍩', '🍪', '☕', '🍺'
        ];

        const CHANNEL_AVATARS = ['📢', '🎯', '💬', '🔊', '📡', '🎵', '🎮', '📺', '⚽', '🏀', '🎨', '📚', '🎭', '🎪', '🎤', '🎧'];

        // ========== ПЛАВНЫЕ УВЕДОМЛЕНИЯ ==========
        let notificationTimeout = null;

        function showNotification(message, title = 'SignalWire', type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            notification.classList.remove('fade-out', 'success', 'error', 'news');
            notification.classList.add(type);
            
            let iconName = 'plug';
            if (type === 'success') iconName = 'check-circle';
            if (type === 'error') iconName = 'exclamation-circle';
            if (type === 'news') iconName = 'broadcast-tower';
            
            icon.innerHTML = `<i class="fas fa-${iconName}"></i>`;
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            notification.style.display = 'block';
            
            notificationTimeout = setTimeout(() => {
                closeNotification();
            }, 4000);
        }

        window.closeNotification = function() {
            const notification = document.getElementById('notification');
            notification.classList.add('fade-out');
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('fade-out');
            }, 300);
        };

        // ========== UTILITY FUNCTIONS ==========
        const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const isAdmin = () => State.currentUser?.username === ADMIN_USERNAME;
        const isBlocked = (userId) => State.blockedUsers.has(userId);
        
        const escapeHTML = (str) => {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        // ========== THEME MANAGEMENT ==========
        const setTheme = (theme) => {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('darkThemeBtn')?.classList.remove('active');
                document.getElementById('lightThemeBtn')?.classList.add('active');
                document.getElementById('themeColor')?.setAttribute('content', '#f0f2f5');
                if (State.currentUser) State.currentUser.theme = 'light';
            } else {
                document.body.classList.remove('light-theme');
                document.getElementById('darkThemeBtn')?.classList.add('active');
                document.getElementById('lightThemeBtn')?.classList.remove('active');
                document.getElementById('themeColor')?.setAttribute('content', '#000000');
                if (State.currentUser) State.currentUser.theme = 'dark';
            }
        };

        // ========== STICKERS ==========
        function initStickers() {
            const stickerGrid = document.getElementById('stickerGrid');
            if (!stickerGrid) return;
            
            stickerGrid.innerHTML = '';
            STICKERS.forEach(sticker => {
                const div = document.createElement('div');
                div.className = 'sticker-item';
                div.textContent = sticker;
                div.onclick = () => {
                    if (State.currentChannel) {
                        sendChannelMessage(State.currentChannel.id, sticker, true);
                    } else if (State.currentChatUser) {
                        if (isBlocked(State.currentChatUser.id)) {
                            showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                            return;
                        }
                        sendPrivateMessage(State.currentChatUser.id, sticker, true);
                    } else {
                        showNotification('❌ Выберите чат или канал', 'Ошибка', 'error');
                    }
                    document.getElementById('stickerPanel').classList.remove('visible');
                    document.getElementById('stickerBtn').classList.remove('active');
                };
                stickerGrid.appendChild(div);
            });
        }

        // ========== NEWS MANAGEMENT ==========
        const loadNews = () => {
            database.ref('news').orderByChild('timestamp').once('value', (snapshot) => {
                const news = snapshot.val() || {};
                State.news = Object.values(news).sort((a, b) => b.timestamp - a.timestamp);
                renderNews();
            });
            
            database.ref('news').on('child_added', () => {
                database.ref('news').orderByChild('timestamp').once('value', (snapshot) => {
                    const news = snapshot.val() || {};
                    State.news = Object.values(news).sort((a, b) => b.timestamp - a.timestamp);
                    renderNews();
                    
                    if (State.currentUser && document.getElementById('newsModal').style.display !== 'flex') {
                        document.getElementById('newsBadge').classList.remove('hidden');
                        showNotification('📢 Появилась новая новость!', 'SignalWire', 'news');
                    }
                });
            });
        };

        const renderNews = () => {
            const container = document.getElementById('newsContainer');
            if (!container) return;
            
            if (State.news.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-broadcast-tower" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>Новостей пока нет</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = State.news.map(item => `
                <div class="news-item">
                    <div class="news-item-header">
                        <span class="news-item-title">${escapeHTML(item.title)}</span>
                        <span class="news-item-date">${new Date(item.timestamp).toLocaleDateString('ru-RU')}</span>
                    </div>
                    <div class="news-item-content">${escapeHTML(item.content)}</div>
                    <div class="news-item-author">
                        <i class="fas fa-user"></i>
                        ${escapeHTML(item.authorName)} · @${escapeHTML(item.authorUsername)}
                    </div>
                </div>
            `).join('');
        };

        const publishNews = () => {
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();
            
            if (!title || !content) {
                showNotification('❌ Заполните заголовок и текст новости', 'Ошибка', 'error');
                return;
            }
            
            const newsRef = database.ref('news').push();
            newsRef.set({
                id: newsRef.key,
                title: title,
                content: content,
                authorId: State.currentUser.id,
                authorName: State.currentUser.name,
                authorUsername: State.currentUser.username,
                timestamp: Date.now()
            }).then(() => {
                document.getElementById('newsTitle').value = '';
                document.getElementById('newsContent').value = '';
                showNotification('✅ Новость опубликована', 'Успешно', 'success');
            });
        };

        // ========== ADMIN PANEL ==========
        const renderAdminPanel = () => {
            if (!isAdmin()) {
                document.getElementById('adminPanel').classList.add('hidden');
                return;
            }
            
            document.getElementById('adminPanel').classList.remove('hidden');
            
            const totalUsers = Object.keys(State.allUsers).length;
            const onlineCount = Object.values(State.onlineUsers).filter(status => status === true).length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('onlineUsers').textContent = onlineCount;
            
            const usersList = document.getElementById('adminUsersList');
            usersList.innerHTML = '';
            
            const users = Object.entries(State.allUsers)
                .map(([id, user]) => ({ id, ...user }))
                .sort((a, b) => {
                    const aOnline = State.onlineUsers[a.id] ? 1 : 0;
                    const bOnline = State.onlineUsers[b.id] ? 1 : 0;
                    return bOnline - aOnline;
                })
                .slice(0, 10);
            
            users.forEach(user => {
                const isOnline = State.onlineUsers[user.id] === true;
                const item = document.createElement('div');
                item.className = 'admin-user-item';
                item.innerHTML = `
                    <div class="admin-user-info">
                        <div class="admin-user-avatar" style="background: ${user.color || '#444'}">
                            ${user.avatar || '👤'}
                        </div>
                        <div class="admin-user-details">
                            <div class="admin-user-name">${escapeHTML(user.name)} ${user.username === ADMIN_USERNAME ? '👑' : ''}</div>
                            <span class="admin-user-username">@${escapeHTML(user.username)}</span>
                        </div>
                    </div>
                    <div class="admin-user-status ${isOnline ? 'online' : 'offline'}"></div>
                `;
                usersList.appendChild(item);
            });
        };

        // ========== БЛОКИРОВКА ПОЛЬЗОВАТЕЛЕЙ ==========
        const blockUser = (userId) => {
            if (!State.currentUser) return;
            
            State.blockedUsers.add(userId);
            database.ref('blocked/' + State.currentUser.id + '/' + userId).set(true);
            showNotification('✅ Пользователь заблокирован', 'Успешно', 'success');
            
            // Если текущий чат с заблокированным пользователем - закрываем
            if (State.currentChatUser?.id === userId) {
                document.getElementById('chatActive').style.display = 'none';
                document.getElementById('chatPlaceholder').style.display = 'flex';
                State.currentChatUser = null;
                State.currentChatId = null;
            }
        };

        const unblockUser = (userId) => {
            if (!State.currentUser) return;
            
            State.blockedUsers.delete(userId);
            database.ref('blocked/' + State.currentUser.id + '/' + userId).remove();
            showNotification('✅ Пользователь разблокирован', 'Успешно', 'success');
        };

        // ========== УДАЛЕНИЕ ЧАТА ==========
        const deleteChat = (userId) => {
            if (!State.currentUser || !confirm('Удалить этот чат?')) return;
            
            const chatId = [State.currentUser.id, userId].sort().join('_');
            
            // Удаляем сообщения
            database.ref('chats/' + chatId).remove();
            
            // Удаляем из списка чатов
            State.userChats.delete(userId);
            database.ref('userChats/' + State.currentUser.id + '/' + userId).remove();
            
            renderChatsList();
            
            // Если текущий чат - закрываем
            if (State.currentChatUser?.id === userId) {
                document.getElementById('chatActive').style.display = 'none';
                document.getElementById('chatPlaceholder').style.display = 'flex';
                State.currentChatUser = null;
                State.currentChatId = null;
            }
            
            showNotification('✅ Чат удален', 'Успешно', 'success');
        };

        // ========== КАНАЛЫ ==========
        const initOfficialChannel = () => {
            database.ref('channels/' + OFFICIAL_CHANNEL_ID).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    const officialChannel = {
                        id: OFFICIAL_CHANNEL_ID,
                        name: 'SignalWire',
                        description: '🔌 Официальный канал SignalWire. Новости, обновления, события.',
                        creator: 'system',
                        creatorName: 'SignalWire',
                        creatorUsername: 'signalwire',
                        createdAt: Date.now(),
                        isOfficial: true,
                        members: {
                            system: {
                                role: 'creator',
                                joinedAt: Date.now()
                            }
                        },
                        subscribers: {},
                        avatar: '📢',
                        color: '#00b894'
                    };
                    
                    database.ref('channels/' + OFFICIAL_CHANNEL_ID).set(officialChannel);
                }
            });
        };

        const loadChannels = () => {
            database.ref('channels').on('value', (snapshot) => {
                State.channels = snapshot.val() || {};
                renderMyChannels();
            });
        };

        const renderMyChannels = () => {
            const container = document.getElementById('myChannelsList');
            if (!container || !State.currentUser) return;
            
            container.innerHTML = '';
            
            // Получаем каналы, на которые подписан пользователь
            const myChannels = [];
            
            Object.values(State.channels).forEach(channel => {
                const isSubscribed = channel.subscribers && channel.subscribers[State.currentUser.id];
                const isCreator = channel.creator === State.currentUser.id;
                const isOfficial = channel.id === OFFICIAL_CHANNEL_ID;
                
                if (isOfficial || isSubscribed || isCreator) {
                    myChannels.push(channel);
                    State.subscribedChannels.add(channel.id);
                }
            });
            
            // Сортируем: официальный канал всегда первый
            myChannels.sort((a, b) => {
                if (a.id === OFFICIAL_CHANNEL_ID) return -1;
                if (b.id === OFFICIAL_CHANNEL_ID) return 1;
                return 0;
            });
            
            if (myChannels.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <p>Вы не подписаны ни на один канал</p>
                    </div>
                `;
                return;
            }
            
            myChannels.forEach(channel => {
                const isOfficial = channel.id === OFFICIAL_CHANNEL_ID;
                const isActive = State.currentChannel?.id === channel.id;
                const isCreator = channel.creator === State.currentUser.id;
                
                const item = document.createElement('div');
                item.className = `channel-item ${isActive ? 'active' : ''}`;
                item.dataset.channelId = channel.id;
                
                item.innerHTML = `
                    <div class="channel-avatar" style="background: ${channel.color || 'var(--channel)'}">
                        ${channel.avatar || '📢'}
                    </div>
                    <div class="channel-info">
                        <div class="channel-name">
                            <span>${escapeHTML(channel.name)}</span>
                            ${isOfficial ? '<span class="channel-badge">📢</span>' : ''}
                            ${isCreator ? '<span style="color: var(--admin); font-size: 12px;">👑</span>' : ''}
                        </div>
                        <div class="channel-meta">
                            <span class="channel-creator">@${escapeHTML(channel.creatorUsername)}</span>
                            <span> · </span>
                            <span>${channel.subscribers ? Object.keys(channel.subscribers).length : 1} участников</span>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => joinChannel(channel.id, channel));
                container.appendChild(item);
            });
        };

        const createChannel = () => {
            const name = document.getElementById('channelName').value.trim();
            const description = document.getElementById('channelDescription').value.trim() || 'Канал SignalWire';
            
            if (!name) {
                showNotification('❌ Введите название канала', 'Ошибка', 'error');
                return;
            }
            
            const channelId = 'channel_' + Date.now();
            const channelAvatar = getRandomElement(CHANNEL_AVATARS);
            const channelColor = getRandomElement(COLORS);
            
            const channel = {
                id: channelId,
                name: name,
                description: description,
                creator: State.currentUser.id,
                creatorName: State.currentUser.name,
                creatorUsername: State.currentUser.username,
                createdAt: Date.now(),
                isOfficial: false,
                avatar: channelAvatar,
                color: channelColor,
                members: {
                    [State.currentUser.id]: {
                        role: 'creator',
                        joinedAt: Date.now()
                    }
                },
                subscribers: {
                    [State.currentUser.id]: {
                        role: 'creator',
                        subscribedAt: Date.now()
                    }
                }
            };
            
            database.ref('channels/' + channelId).set(channel).then(() => {
                document.getElementById('channelModal').style.display = 'none';
                document.getElementById('channelName').value = '';
                document.getElementById('channelDescription').value = '';
                
                State.subscribedChannels.add(channelId);
                joinChannel(channelId, channel);
                showNotification(`✅ Канал "${name}" создан`, 'Успешно', 'success');
            });
        };

        const subscribeToChannel = (channelId, channel) => {
            if (!State.currentUser) return;
            
            // Добавляем подписчика
            database.ref('channels/' + channelId + '/subscribers/' + State.currentUser.id).set({
                subscribedAt: Date.now(),
                username: State.currentUser.username,
                name: State.currentUser.name
            });
            
            // Добавляем в участники
            database.ref('channels/' + channelId + '/members/' + State.currentUser.id).set({
                role: 'member',
                joinedAt: Date.now()
            });
            
            State.subscribedChannels.add(channelId);
            
            showNotification(`✅ Вы подписались на канал "${channel.name}"`, 'Успешно', 'success');
            renderMyChannels();
            joinChannel(channelId, channel);
        };

        const unsubscribeFromChannel = (channelId, channel) => {
            if (!State.currentUser || channel.id === OFFICIAL_CHANNEL_ID) {
                showNotification('❌ Нельзя отписаться от официального канала', 'Ошибка', 'error');
                return;
            }
            
            if (confirm(`Отписаться от канала "${channel.name}"?`)) {
                // Удаляем подписчика
                database.ref('channels/' + channelId + '/subscribers/' + State.currentUser.id).remove();
                database.ref('channels/' + channelId + '/members/' + State.currentUser.id).remove();
                
                State.subscribedChannels.delete(channelId);
                
                showNotification(`✅ Вы отписались от канала "${channel.name}"`, 'Успешно', 'success');
                
                // Если текущий канал - закрываем
                if (State.currentChannel?.id === channelId) {
                    document.getElementById('chatActive').style.display = 'none';
                    document.getElementById('chatPlaceholder').style.display = 'flex';
                    State.currentChannel = null;
                    State.currentChatId = null;
                }
                
                renderMyChannels();
            }
        };

        const deleteChannel = (channelId, channel) => {
            if (!State.currentUser || channel.creator !== State.currentUser.id) {
                showNotification('❌ Только создатель может удалить канал', 'Ошибка', 'error');
                return;
            }
            
            if (confirm(`Удалить канал "${channel.name}"? Это действие нельзя отменить.`)) {
                // Удаляем канал и все сообщения
                database.ref('channels/' + channelId).remove();
                database.ref('channelMessages/' + channelId).remove();
                
                showNotification(`✅ Канал "${channel.name}" удален`, 'Успешно', 'success');
                
                // Если текущий канал - закрываем
                if (State.currentChannel?.id === channelId) {
                    document.getElementById('chatActive').style.display = 'none';
                    document.getElementById('chatPlaceholder').style.display = 'flex';
                    State.currentChannel = null;
                    State.currentChatId = null;
                }
                
                renderMyChannels();
                document.getElementById('channelEditModal').style.display = 'none';
            }
        };

        const editChannel = () => {
            if (!State.currentEditingChannel) return;
            
            const newName = document.getElementById('editChannelName').value.trim();
            const newDescription = document.getElementById('editChannelDescription').value.trim();
            
            if (!newName) {
                showNotification('❌ Введите название канала', 'Ошибка', 'error');
                return;
            }
            
            const updates = {};
            updates['channels/' + State.currentEditingChannel.id + '/name'] = newName;
            updates['channels/' + State.currentEditingChannel.id + '/description'] = newDescription;
            
            database.ref().update(updates).then(() => {
                document.getElementById('channelEditModal').style.display = 'none';
                showNotification('✅ Канал обновлен', 'Успешно', 'success');
                
                if (State.currentChannel?.id === State.currentEditingChannel.id) {
                    State.currentChannel.name = newName;
                    State.currentChannel.description = newDescription;
                    updateChannelHeader();
                }
                
                State.currentEditingChannel = null;
                renderMyChannels();
            });
        };

        const openChannelProfile = (channel) => {
            const isSubscribed = State.subscribedChannels.has(channel.id);
            const isCreator = State.currentUser && channel.creator === State.currentUser.id;
            const isOfficial = channel.id === OFFICIAL_CHANNEL_ID;
            const memberCount = channel.subscribers ? Object.keys(channel.subscribers).length : 1;
            
            document.getElementById('channelProfileContent').innerHTML = `
                <div class="channel-profile-avatar" style="background: ${channel.color || 'var(--channel)'}">
                    ${channel.avatar || '📢'}
                </div>
                <div class="channel-profile-name">
                    <h3>${escapeHTML(channel.name)}</h3>
                    <span class="channel-profile-id">@${escapeHTML(channel.creatorUsername)}</span>
                </div>
                
                <div class="channel-profile-description">
                    ${escapeHTML(channel.description) || 'Описание отсутствует'}
                </div>
                
                <div class="channel-profile-stats">
                    <div class="channel-profile-stat">
                        <div class="channel-profile-stat-value">${memberCount}</div>
                        <div class="channel-profile-stat-label">участников</div>
                    </div>
                    <div class="channel-profile-stat">
                        <div class="channel-profile-stat-value">${new Date(channel.createdAt).toLocaleDateString('ru-RU', {day: 'numeric', month: 'numeric'})}</div>
                        <div class="channel-profile-stat-label">создан</div>
                    </div>
                </div>
                
                <div class="channel-profile-creator">
                    <i class="fas fa-crown"></i>
                    Создатель: @${escapeHTML(channel.creatorUsername)}
                </div>
                
                <div class="channel-profile-actions">
                    ${!isSubscribed ? `
                        <button class="channel-profile-btn channel-profile-join-btn" onclick="handleSubscribe('${channel.id}')">
                            <i class="fas fa-bell"></i>
                            Подписаться
                        </button>
                    ` : `
                        <button class="channel-profile-btn channel-profile-join-btn" onclick="joinChannel('${channel.id}', ${JSON.stringify(channel).replace(/"/g, '&quot;')})">
                            <i class="fas fa-sign-in-alt"></i>
                            Перейти
                        </button>
                        ${!isOfficial ? `
                            <button class="channel-profile-btn channel-profile-leave-btn" onclick="handleUnsubscribe('${channel.id}')">
                                <i class="fas fa-bell-slash"></i>
                                Отписаться
                            </button>
                        ` : ''}
                    `}
                    ${isCreator ? `
                        <button class="channel-profile-btn channel-profile-edit-btn" onclick="openChannelEditModal('${channel.id}')">
                            <i class="fas fa-edit"></i>
                            Редактировать
                        </button>
                    ` : ''}
                </div>
            `;
            
            // Добавляем функцию подписки в глобальную область
            window.handleSubscribe = (cid) => subscribeToChannel(cid, State.channels[cid]);
            window.handleUnsubscribe = (cid) => unsubscribeFromChannel(cid, State.channels[cid]);
            
            document.getElementById('channelProfileModal').style.display = 'flex';
        };

        window.openChannelEditModal = (channelId) => {
            const channel = State.channels[channelId];
            if (!channel) return;
            
            State.currentEditingChannel = channel;
            document.getElementById('editChannelName').value = channel.name;
            document.getElementById('editChannelDescription').value = channel.description || '';
            document.getElementById('editChannelAvatar').innerHTML = channel.avatar || '📢';
            document.getElementById('editChannelAvatar').style.background = channel.color || 'var(--channel)';
            
            // Добавляем кнопку удаления
            document.getElementById('deleteChannelBtn').onclick = () => deleteChannel(channelId, channel);
            
            document.getElementById('channelEditModal').style.display = 'flex';
            document.getElementById('channelProfileModal').style.display = 'none';
        };

        const joinChannel = (channelId, channel) => {
            // Clean up previous listeners
            if (State.userMessagesListener) {
                database.ref('chats/' + State.currentChatId).off('value', State.userMessagesListener);
                State.userMessagesListener = null;
            }
            
            if (State.channelMessagesListener) {
                database.ref('channelMessages/' + State.currentChannel?.id).off('value', State.channelMessagesListener);
                State.channelMessagesListener = null;
            }
            
            State.currentChannel = channel;
            State.currentChatUser = null;
            State.currentChatId = 'channel_' + channelId;
            
            // Update UI
            updateChannelHeader();
            
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatActive').style.display = 'flex';
            
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('visible');
            }
            
            renderMyChannels();
            loadChannelMessages(channelId);
            
            // Close channel profile if open
            document.getElementById('channelProfileModal').style.display = 'none';
            document.getElementById('channelSearchResults').classList.remove('visible');
        };

        const updateChannelHeader = () => {
            if (!State.currentChannel) return;
            
            document.getElementById('currentChatUser').innerHTML = `
                <div class="channel-avatar-large" style="background: ${State.currentChannel.color || 'var(--channel)'}">
                    ${State.currentChannel.avatar || '📢'}
                </div>
                <div class="chat-user-info">
                    <h3>
                        ${escapeHTML(State.currentChannel.name)}
                        ${State.currentChannel.id === OFFICIAL_CHANNEL_ID ? '<span class="channel-tag">📢 Официальный</span>' : ''}
                    </h3>
                    <span class="chat-user-username">@${escapeHTML(State.currentChannel.creatorUsername)}</span>
                </div>
            `;
            
            // Click on channel profile
            document.querySelector('.chat-user').onclick = () => openChannelProfile(State.currentChannel);
        };

        const loadChannelMessages = (channelId) => {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            State.channelMessagesListener = database.ref('channelMessages/' + channelId)
                .limitToLast(50)
                .on('value', (snapshot) => {
                    const messages = snapshot.val() || {};
                    container.innerHTML = '';
                    
                    Object.values(messages)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(msg => {
                            const messageEl = document.createElement('div');
                            messageEl.className = 'message channel-message';
                            
                            const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                            
                            let content = '';
                            if (msg.isSticker) {
                                content = `<div class="message-sticker">${msg.text}</div>`;
                            } else {
                                content = `<div class="message-text">${escapeHTML(msg.text)}</div>`;
                            }
                            
                            messageEl.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-weight: 600; color: white;">${escapeHTML(msg.senderName)}</span>
                                    <span style="font-size: 11px; opacity: 0.8;">@${escapeHTML(msg.senderUsername)}</span>
                                </div>
                                ${content}
                                <div class="message-time">${time}</div>
                            `;
                            
                            container.appendChild(messageEl);
                        });
                    
                    container.scrollTop = container.scrollHeight;
                });
        };

        const sendChannelMessage = (channelId, text, isSticker = false) => {
            if (!text.trim()) return;
            
            const messageId = database.ref('channelMessages/' + channelId).push().key;
            
            database.ref('channelMessages/' + channelId + '/' + messageId).set({
                senderId: State.currentUser.id,
                senderName: State.currentUser.name,
                senderUsername: State.currentUser.username,
                text: text.trim(),
                isSticker: isSticker,
                timestamp: Date.now()
            });
        };

        // ========== ПОИСК КАНАЛОВ ==========
        const setupChannelSearch = () => {
            document.getElementById('channelSearchInput').addEventListener('input', function() {
                clearTimeout(State.channelSearchTimeout);
                const searchText = this.value.trim().toLowerCase();
                const resultsDiv = document.getElementById('channelSearchResults');
                
                if (searchText.length < 2) {
                    resultsDiv.classList.remove('visible');
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                State.channelSearchTimeout = setTimeout(() => {
                    const results = [];
                    
                    Object.values(State.channels).forEach(channel => {
                        if (channel.name.toLowerCase().includes(searchText) || 
                            (channel.description && channel.description.toLowerCase().includes(searchText))) {
                            results.push(channel);
                        }
                    });
                    
                    renderChannelSearchResults(results);
                }, 300);
            });
        };

        const renderChannelSearchResults = (results) => {
            const container = document.getElementById('channelSearchResults');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-bullhorn" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>Каналы не найдены</p>
                    </div>
                `;
                container.classList.add('visible');
                return;
            }
            
            results.slice(0, 5).forEach(channel => {
                const isSubscribed = State.subscribedChannels.has(channel.id);
                const isOfficial = channel.id === OFFICIAL_CHANNEL_ID;
                
                const item = document.createElement('div');
                item.className = 'channel-search-item';
                item.innerHTML = `
                    <div class="channel-search-avatar" style="background: ${channel.color || 'var(--channel)'}">
                        ${channel.avatar || '📢'}
                    </div>
                    <div class="channel-search-info">
                        <div class="channel-search-name">
                            <span>${escapeHTML(channel.name)}</span>
                            <span class="channel-search-creator">@${escapeHTML(channel.creatorUsername)}</span>
                            ${isOfficial ? '<span style="color: var(--channel); font-size: 11px;">📢</span>' : ''}
                            ${isSubscribed ? '<span style="color: var(--success); font-size: 11px;">✓</span>' : ''}
                        </div>
                        <div class="channel-search-description">
                            ${escapeHTML(channel.description?.substring(0, 30) || 'Канал')}...
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    openChannelProfile(channel);
                    container.classList.remove('visible');
                    document.getElementById('channelSearchInput').value = '';
                });
                
                container.appendChild(item);
            });
            
            container.classList.add('visible');
        };

        // ========== USER PROFILE ==========
        const openUserProfile = (user) => {
            const isOnline = State.onlineUsers[user.id] === true;
            const isBlocked = State.blockedUsers.has(user.id);
            const lastSeen = user.lastSeen 
                ? new Date(user.lastSeen).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
                : 'давно';
            
            database.ref('chats/' + [State.currentUser.id, user.id].sort().join('_')).once('value', (snapshot) => {
                const messages = snapshot.val() || {};
                const messagesCount = Object.keys(messages).length;
                
                document.getElementById('profileContent').innerHTML = `
                    <div class="user-profile-avatar" style="background: ${user.color}; border-color: ${user.color};">
                        ${user.avatar || '👤'}
                    </div>
                    <div class="user-profile-name">
                        <h3>
                            ${escapeHTML(user.name)}
                            <span style="font-size: 16px; color: ${isOnline ? 'var(--online)' : 'var(--text-muted)'};">
                                <i class="fas fa-circle"></i>
                            </span>
                        </h3>
                        <span class="user-profile-username">@${escapeHTML(user.username)}</span>
                    </div>
                    <div class="user-profile-bio">
                        ${escapeHTML(user.bio) || 'Анонимный пользователь'}
                    </div>
                    <div class="user-profile-stats">
                        <div class="stat-item">
                            <div class="stat-value">${messagesCount}</div>
                            <div class="stat-label">сообщений</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${user.registeredAt ? new Date(user.registeredAt).toLocaleDateString('ru-RU', {day: 'numeric', month: 'numeric'}) : '—'}</div>
                            <div class="stat-label">регистрация</div>
                        </div>
                    </div>
                    <div class="user-profile-status">
                        <i class="fas ${isOnline ? 'fa-circle status-online' : 'fa-clock'}"></i>
                        ${isOnline ? 'В сети' : 'Был(а): ' + lastSeen}
                    </div>
                    <div class="user-profile-actions">
                        <button class="profile-action-btn message-btn" onclick="document.getElementById('closeProfileBtn').click()">
                            <i class="fas fa-paper-plane"></i>
                            Написать
                        </button>
                        ${isBlocked ? `
                            <button class="profile-action-btn block-btn" onclick="unblockUser('${user.id}'); document.getElementById('closeProfileBtn').click()">
                                <i class="fas fa-check-circle"></i>
                                Разблокировать
                            </button>
                        ` : `
                            <button class="profile-action-btn block-btn" onclick="blockUser('${user.id}'); document.getElementById('closeProfileBtn').click()">
                                <i class="fas fa-ban"></i>
                                Заблокировать
                            </button>
                        `}
                        <button class="profile-action-btn delete-chat-btn" onclick="deleteChat('${user.id}'); document.getElementById('closeProfileBtn').click()">
                            <i class="fas fa-trash"></i>
                            Удалить чат
                        </button>
                    </div>
                `;
                
                document.getElementById('userProfileModal').style.display = 'flex';
            });
        };

        // Делаем функции глобальными
        window.blockUser = blockUser;
        window.unblockUser = unblockUser;
        window.deleteChat = deleteChat;

        // ========== PRIVATE MESSAGES ==========
        const setupIncomingMessagesListener = () => {
            if (!State.currentUser) return;
            
            database.ref('chats').on('value', (snapshot) => {
                const allChats = snapshot.val() || {};
                
                Object.keys(allChats).forEach(chatId => {
                    const [user1, user2] = chatId.split('_');
                    
                    if (user1 === State.currentUser.id || user2 === State.currentUser.id) {
                        const otherUserId = user1 === State.currentUser.id ? user2 : user1;
                        
                        if (!State.blockedUsers.has(otherUserId)) {
                            State.userChats.add(otherUserId);
                            database.ref('userChats/' + State.currentUser.id + '/' + otherUserId).set(true);
                        }
                    }
                });
                
                renderChatsList();
            });
        };

        const loadPrivateMessages = (userId) => {
            if (isBlocked(userId)) {
                showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                return;
            }
            
            const chatId = [State.currentUser.id, userId].sort().join('_');
            const container = document.getElementById('messagesContainer');
            
            if (State.userMessagesListener) {
                database.ref('chats/' + State.currentChatId).off('value', State.userMessagesListener);
            }
            
            State.userMessagesListener = database.ref('chats/' + chatId)
                .limitToLast(50)
                .on('value', (snapshot) => {
                    const messages = snapshot.val() || {};
                    container.innerHTML = '';
                    
                    Object.values(messages)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(msg => {
                            if (isBlocked(msg.senderId)) return;
                            
                            const messageEl = document.createElement('div');
                            messageEl.className = `message ${msg.senderId === State.currentUser.id ? 'sent' : 'received'}`;
                            
                            const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                            
                            let content = '';
                            if (msg.isSticker) {
                                content = `<div class="message-sticker">${msg.text}</div>`;
                            } else {
                                content = `<div class="message-text">${escapeHTML(msg.text)}</div>`;
                            }
                            
                            messageEl.innerHTML = content + `<div class="message-time">${time}</div>`;
                            
                            container.appendChild(messageEl);
                        });
                    
                    container.scrollTop = container.scrollHeight;
                });
        };

        const startPrivateChat = (userId, user) => {
            if (isBlocked(userId)) {
                showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                return;
            }
            
            // Clean up previous listeners
            if (State.channelMessagesListener) {
                database.ref('channelMessages/' + State.currentChannel?.id).off('value', State.channelMessagesListener);
                State.channelMessagesListener = null;
            }
            
            if (State.userMessagesListener) {
                database.ref('chats/' + State.currentChatId).off('value', State.userMessagesListener);
                State.userMessagesListener = null;
            }
            
            State.currentChatUser = { id: userId, ...user };
            State.currentChannel = null;
            State.currentChatId = [State.currentUser.id, userId].sort().join('_');
            
            State.userChats.add(userId);
            database.ref('userChats/' + State.currentUser.id + '/' + userId).set(true);
            
            const isOnline = State.onlineUsers[userId] === true;
            const isAdminUser = user.username === ADMIN_USERNAME;
            
            document.getElementById('currentChatUser').innerHTML = `
                <div class="chat-user-avatar" style="background: ${user.color || '#444'}">
                    ${user.avatar || '👤'}
                    ${isOnline ? '<div class="online-badge"></div>' : ''}
                </div>
                <div class="chat-user-info">
                    <h3>
                        ${escapeHTML(user.name)}
                        ${isAdminUser ? '<span class="admin-tag">👑</span>' : ''}
                    </h3>
                    <span class="chat-user-username">@${escapeHTML(user.username)}</span>
                </div>
            `;
            
            // Click on user profile
            document.querySelector('.chat-user').onclick = () => openUserProfile(State.currentChatUser);
            
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatActive').style.display = 'flex';
            
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('visible');
            }
            
            renderChatsList();
            loadPrivateMessages(userId);
        };

        const sendPrivateMessage = (userId, text, isSticker = false) => {
            if (!text.trim()) return;
            if (isBlocked(userId)) {
                showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                return;
            }
            
            const chatId = [State.currentUser.id, userId].sort().join('_');
            const messageId = database.ref('chats/' + chatId).push().key;
            
            const message = {
                senderId: State.currentUser.id,
                senderName: State.currentUser.name,
                text: text.trim(),
                isSticker: isSticker,
                timestamp: Date.now()
            };
            
            database.ref('chats/' + chatId + '/' + messageId).set(message);
            
            // Send notification
            sendNotification(userId, State.currentUser.name, text);
            
            // Add to recipient's chat list
            database.ref('userChats/' + userId + '/' + State.currentUser.id).set(true);
        };

        // ========== NOTIFICATIONS ==========
        const sendNotification = (userId, fromName, text) => {
            if (!userId || !fromName) return;
            if (isBlocked(userId)) return;
            
            const notificationRef = database.ref('notifications/' + userId).push();
            notificationRef.set({
                from: State.currentUser.id,
                fromName: fromName,
                text: text.length > 30 ? text.substring(0, 30) + '...' : text,
                timestamp: Date.now(),
                read: false
            });
        };

        const setupNotificationsListener = () => {
            if (!State.currentUser) return;
            
            database.ref('notifications/' + State.currentUser.id).off();
            database.ref('notifications/' + State.currentUser.id).on('child_added', (snapshot) => {
                const notif = snapshot.val();
                
                if (notif.from && notif.from !== State.currentUser.id && !isBlocked(notif.from)) {
                    State.userChats.add(notif.from);
                    database.ref('userChats/' + State.currentUser.id + '/' + notif.from).set(true);
                    renderChatsList();
                }
                
                showNotification(`📨 ${notif.fromName}: ${notif.text}`, 'Новое сообщение', 'info');
                setTimeout(() => snapshot.ref.remove(), 1000);
            });
        };

        // ========== RENDER FUNCTIONS ==========
        const renderChatsList = () => {
            const container = document.getElementById('chatsContainer');
            if (!container || !State.currentUser) return;
            
            container.innerHTML = '';
            
            if (State.userChats.size === 0) {
                container.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-plug" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <h3 style="margin-bottom: 8px;">Нет подключений</h3>
                        <p style="font-size: 14px;">Вам еще никто не писал</p>
                    </div>
                `;
                return;
            }
            
            const chatUsers = [];
            State.userChats.forEach(userId => {
                if (State.allUsers[userId] && userId !== State.currentUser.id && !isBlocked(userId)) {
                    chatUsers.push({ id: userId, ...State.allUsers[userId] });
                }
            });
            
            chatUsers.sort((a, b) => 
                (State.onlineUsers[b.id] ? 1 : 0) - (State.onlineUsers[a.id] ? 1 : 0)
            );
            
            chatUsers.forEach(user => {
                const isOnline = State.onlineUsers[user.id] === true;
                const isAdminUser = user.username === ADMIN_USERNAME;
                const isActive = State.currentChatUser?.id === user.id;
                
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${isActive ? 'active' : ''}`;
                chatItem.dataset.userId = user.id;
                
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="background: ${user.color || '#444'}">
                        ${user.avatar || '👤'}
                        ${isOnline ? '<div class="online-badge"></div>' : ''}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">
                            <span>${escapeHTML(user.name)}</span>
                            <span class="chat-username">@${escapeHTML(user.username)}</span>
                            ${isAdminUser ? '<span style="color: var(--admin);">👑</span>' : ''}
                        </div>
                        <div class="chat-preview">${escapeHTML(user.bio) || 'Анонимный пользователь'}</div>
                    </div>
                `;
                
                chatItem.addEventListener('click', () => startPrivateChat(user.id, user));
                container.appendChild(chatItem);
            });
        };

        const renderSearchResults = (results, isExactUsername) => {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <i class="fas fa-plug" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>${isExactUsername ? 'Абонент не найден' : 'Ничего не найдено'}</p>
                    </div>
                `;
                container.classList.add('visible');
                return;
            }
            
            results.slice(0, 5).forEach(user => {
                if (isBlocked(user.id)) return;
                
                const isAdminUser = user.username === ADMIN_USERNAME;
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div class="search-result-avatar" style="background: ${user.color || '#444'}">
                        ${user.avatar || '👤'}
                    </div>
                    <div class="search-result-info">
                        <div class="search-result-name">
                            <span>${escapeHTML(user.name)}</span>
                            <span class="search-result-username">@${escapeHTML(user.username)}</span>
                            ${isAdminUser ? '<span style="color: var(--admin); font-size: 12px;">👑</span>' : ''}
                        </div>
                        <div class="search-result-bio">${escapeHTML(user.bio) || 'Анонимный пользователь'}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    startPrivateChat(user.id, user);
                    container.classList.remove('visible');
                    document.getElementById('searchInput').value = '';
                });
                
                container.appendChild(item);
            });
            
            container.classList.add('visible');
        };

        // ========== USER CARD ==========
        const updateUserCard = () => {
            const card = document.getElementById('userCard');
            if (!card || !State.currentUser) return;
            
            const isAdminUser = isAdmin();
            
            card.innerHTML = `
                <div class="user-info">
                    <div class="user-avatar" style="background: ${State.currentUser.color}">
                        ${State.currentUser.avatar || '👤'}
                    </div>
                    <div class="user-details">
                        <h4>
                            ${escapeHTML(State.currentUser.name)}
                            ${isAdminUser ? '<span class="admin-badge">👑 АДМИН</span>' : ''}
                            <span class="anonymous-badge">
                                <i class="fas fa-plug"></i> онлайн
                            </span>
                        </h4>
                        <p>@${escapeHTML(State.currentUser.username)}</p>
                    </div>
                </div>
            `;
        };

        // ========== SETTINGS ==========
        const openSettings = () => {
            document.getElementById('settingsName').value = State.currentUser.name || '';
            document.getElementById('settingsUsername').value = State.currentUser.username || '';
            document.getElementById('settingsBio').value = State.currentUser.bio || '';
            
            const avatarSelector = document.getElementById('avatarSelector');
            avatarSelector.innerHTML = '';
            AVATARS.forEach(avatar => {
                const div = document.createElement('div');
                div.className = `avatar-option ${avatar === State.currentUser.avatar ? 'selected' : ''}`;
                div.textContent = avatar;
                div.onclick = function() {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                };
                avatarSelector.appendChild(div);
            });
            
            const colorSelector = document.getElementById('colorSelector');
            colorSelector.innerHTML = '';
            COLORS.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-option ${color === State.currentUser.color ? 'selected' : ''}`;
                div.style.background = color;
                div.onclick = function() {
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                };
                colorSelector.appendChild(div);
            });
            
            document.getElementById('settingsModal').style.display = 'flex';
        };

        const saveSettings = () => {
            const newName = document.getElementById('settingsName').value.trim();
            const newUsername = document.getElementById('settingsUsername').value.trim().toLowerCase();
            const newBio = document.getElementById('settingsBio').value.trim() || 'Анонимный пользователь';
            
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const selectedColor = document.querySelector('.color-option.selected');
            
            if (!newName || !newUsername) {
                showNotification('❌ Заполните имя и никнейм!', 'Ошибка', 'error');
                return;
            }
            
            if (newUsername.length < 3) {
                showNotification('❌ Никнейм минимум 3 символа', 'Ошибка', 'error');
                return;
            }
            
            const updates = {};
            const oldUsername = State.currentUser.username;
            
            const saveProfile = () => {
                State.currentUser.name = newName;
                State.currentUser.username = newUsername;
                State.currentUser.bio = newBio;
                if (selectedAvatar) State.currentUser.avatar = selectedAvatar.textContent;
                if (selectedColor) State.currentUser.color = selectedColor.style.background;
                
                updates['users/' + State.currentUser.id] = State.currentUser;
                
                database.ref().update(updates).then(() => {
                    localStorage.setItem('signalwire_user', JSON.stringify(State.currentUser));
                    updateUserCard();
                    document.getElementById('settingsModal').style.display = 'none';
                    showNotification('✅ Профиль обновлен', 'Успешно', 'success');
                });
            };
            
            if (newUsername !== oldUsername) {
                database.ref('usernames/' + newUsername).once('value').then((snapshot) => {
                    if (snapshot.exists() && snapshot.val() !== State.currentUser.id) {
                        showNotification('❌ Никнейм занят!', 'Ошибка', 'error');
                        return;
                    }
                    
                    updates['usernames/' + oldUsername] = null;
                    updates['usernames/' + newUsername] = State.currentUser.id;
                    saveProfile();
                });
            } else {
                saveProfile();
            }
        };

        // ========== AUTHENTICATION ==========
        const register = () => {
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const password = document.getElementById('regPassword').value.trim();
            const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();
            const bio = document.getElementById('regBio').value.trim() || 'Анонимный пользователь';
            
            if (!name || !username || !password) {
                showNotification('❌ Заполните все поля!', 'Ошибка', 'error');
                return;
            }
            
            if (username.length < 3) {
                showNotification('❌ Никнейм минимум 3 символа', 'Ошибка', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('❌ Пароль минимум 6 символов', 'Ошибка', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('❌ Пароли не совпадают!', 'Ошибка', 'error');
                return;
            }
            
            database.ref('usernames/' + username).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showNotification('❌ Никнейм занят!', 'Ошибка', 'error');
                    return;
                }
                
                const userId = 'user_' + Date.now();
                
                State.currentUser = {
                    id: userId,
                    name: name,
                    username: username,
                    password: password,
                    bio: bio,
                    avatar: getRandomElement(AVATARS),
                    color: getRandomElement(COLORS),
                    theme: 'dark',
                    online: true,
                    lastSeen: Date.now(),
                    registeredAt: Date.now()
                };
                
                const updates = {
                    ['users/' + userId]: State.currentUser,
                    ['usernames/' + username]: userId,
                    ['online/' + userId]: true
                };
                
                database.ref().update(updates).then(() => {
                    localStorage.setItem('signalwire_user', JSON.stringify(State.currentUser));
                    
                    document.getElementById('authModal').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    document.getElementById('sidebar').classList.add('visible');
                    document.getElementById('chatContainer').style.display = 'flex';
                    
                    updateUserCard();
                    loadUsers();
                    setupFirebaseListeners();
                    setupNotificationsListener();
                    setupIncomingMessagesListener();
                    initStickers();
                    
                    // Загружаем заблокированных пользователей
                    database.ref('blocked/' + userId).once('value', (snapshot) => {
                        const blocked = snapshot.val() || {};
                        Object.keys(blocked).forEach(id => State.blockedUsers.add(id));
                    });
                    
                    setTimeout(() => {
                        database.ref('channels/' + OFFICIAL_CHANNEL_ID).once('value', (snapshot) => {
                            if (snapshot.exists()) {
                                const channel = snapshot.val();
                                State.subscribedChannels.add(OFFICIAL_CHANNEL_ID);
                                renderMyChannels();
                                joinChannel(OFFICIAL_CHANNEL_ID, channel);
                            }
                        });
                    }, 1000);
                    
                    showNotification('🔌 Кабель проложен, добро пожаловать!', 'SignalWire', 'success');
                });
            });
        };

        const login = () => {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                showNotification('❌ Введите никнейм и пароль!', 'Ошибка', 'error');
                return;
            }
            
            database.ref('usernames/' + username).once('value').then((snapshot) => {
                const userId = snapshot.val();
                if (!userId) {
                    showNotification('❌ Пользователь не найден!', 'Ошибка', 'error');
                    return;
                }
                
                return database.ref('users/' + userId).once('value');
            }).then((snapshot) => {
                if (!snapshot) return;
                
                const user = snapshot.val();
                
                if (user.password !== password) {
                    showNotification('❌ Неверный пароль!', 'Ошибка', 'error');
                    return;
                }
                
                State.currentUser = user;
                State.currentUser.online = true;
                
                database.ref('online/' + State.currentUser.id).set(true);
                database.ref('users/' + State.currentUser.id + '/lastSeen').set(Date.now());
                
                localStorage.setItem('signalwire_user', JSON.stringify(State.currentUser));
                
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('sidebar').classList.add('visible');
                document.getElementById('chatContainer').style.display = 'flex';
                
                setTheme(State.currentUser.theme || 'dark');
                updateUserCard();
                loadUsers();
                setupFirebaseListeners();
                setupNotificationsListener();
                setupIncomingMessagesListener();
                initStickers();
                
                // Загружаем заблокированных пользователей
                database.ref('blocked/' + State.currentUser.id).once('value', (snapshot) => {
                    const blocked = snapshot.val() || {};
                    Object.keys(blocked).forEach(id => State.blockedUsers.add(id));
                });
                
                setTimeout(() => {
                    database.ref('channels/' + OFFICIAL_CHANNEL_ID).once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const channel = snapshot.val();
                            State.subscribedChannels.add(OFFICIAL_CHANNEL_ID);
                            renderMyChannels();
                            joinChannel(OFFICIAL_CHANNEL_ID, channel);
                        }
                    });
                }, 1000);
                
                showNotification(`🔌 Подключение восстановлено, ${State.currentUser.name}!`, 'SignalWire', 'success');
            });
        };

        // ========== DATA LOADING ==========
        const loadUsers = () => {
            database.ref('users').on('value', (snapshot) => {
                State.allUsers = snapshot.val() || {};
                database.ref('online').on('value', (onlineSnapshot) => {
                    State.onlineUsers = onlineSnapshot.val() || {};
                    renderChatsList();
                    renderAdminPanel();
                });
            });
        };

        // ========== FIREBASE LISTENERS ==========
        const setupFirebaseListeners = () => {
            database.ref('online/' + State.currentUser.id).set(true);
            database.ref('online/' + State.currentUser.id).onDisconnect().set(false);
            
            setInterval(() => {
                if (State.currentUser) {
                    database.ref('online/' + State.currentUser.id).set(true);
                    database.ref('users/' + State.currentUser.id + '/lastSeen').set(Date.now());
                }
            }, 30000);
        };

        // ========== SEARCH ==========
        const setupSearch = () => {
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(State.searchTimeout);
                const searchText = this.value.trim();
                const resultsDiv = document.getElementById('searchResults');
                
                if (searchText.length < 2) {
                    resultsDiv.classList.remove('visible');
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                State.searchTimeout = setTimeout(() => {
                    const isExactUsername = searchText.startsWith('@');
                    const searchTerm = isExactUsername 
                        ? searchText.substring(1).toLowerCase() 
                        : searchText.toLowerCase();
                    
                    const results = [];
                    
                    Object.keys(State.allUsers).forEach(userId => {
                        if (userId === State.currentUser.id) return;
                        if (isBlocked(userId)) return;
                        
                        const user = State.allUsers[userId];
                        
                        if (isExactUsername) {
                            if (user.username.toLowerCase() === searchTerm) {
                                results.push({ id: userId, ...user });
                            }
                        } else {
                            if (user.name.toLowerCase().includes(searchTerm)) {
                                results.push({ id: userId, ...user });
                            }
                        }
                    });
                    
                    renderSearchResults(results, isExactUsername);
                }, 300);
            });
        };

        // ========== EVENT LISTENERS ==========
        const initEventListeners = () => {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('registerTab').classList.remove('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            });
            
            document.getElementById('registerTab').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
            });
            
            // Username check
            document.getElementById('regUsername').addEventListener('input', function() {
                clearTimeout(State.usernameCheckTimeout);
                const username = this.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
                this.value = username;
                
                const checkDiv = document.getElementById('usernameCheck');
                
                if (username.length === 0) {
                    checkDiv.innerHTML = 'Введите никнейм';
                    checkDiv.style.color = 'var(--text-muted)';
                    return;
                }
                
                if (username.length < 3) {
                    checkDiv.innerHTML = '❌ Минимум 3 символа';
                    checkDiv.style.color = '#ffaa00';
                    return;
                }
                
                checkDiv.innerHTML = '⏳ Проверка...';
                checkDiv.style.color = 'var(--text-muted)';
                
                State.usernameCheckTimeout = setTimeout(() => {
                    database.ref('usernames/' + username).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            checkDiv.innerHTML = '❌ Никнейм занят';
                            checkDiv.style.color = 'var(--danger)';
                        } else {
                            checkDiv.innerHTML = '✅ Никнейм свободен!';
                            checkDiv.style.color = 'var(--success)';
                        }
                    }).catch(() => {
                        checkDiv.innerHTML = '❌ Ошибка проверки';
                        checkDiv.style.color = 'var(--danger)';
                    });
                }, 500);
            });
            
            // Auth buttons
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('logoutSettingsBtn').addEventListener('click', () => {
                if (confirm('Отключиться от сети?')) {
                    database.ref('online/' + State.currentUser.id).set(false);
                    localStorage.removeItem('signalwire_user');
                    location.reload();
                }
            });
            
            // Settings
            document.getElementById('openSettingsBtnHeader').addEventListener('click', openSettings);
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'none';
            });
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Theme buttons
            document.getElementById('darkThemeBtn').addEventListener('click', () => setTheme('dark'));
            document.getElementById('lightThemeBtn').addEventListener('click', () => setTheme('light'));
            
            // Navigation
            document.getElementById('chatBackBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('visible');
            });
            
            // Stickers
            document.getElementById('stickerBtn').addEventListener('click', function() {
                const panel = document.getElementById('stickerPanel');
                panel.classList.toggle('visible');
                this.classList.toggle('active');
            });
            
            document.getElementById('closeStickerBtn').addEventListener('click', function() {
                document.getElementById('stickerPanel').classList.remove('visible');
                document.getElementById('stickerBtn').classList.remove('active');
            });
            
            // Profile
            document.getElementById('closeProfileBtn').addEventListener('click', () => {
                document.getElementById('userProfileModal').style.display = 'none';
            });
            
            // Channel profile
            document.getElementById('closeChannelProfileBtn').addEventListener('click', () => {
                document.getElementById('channelProfileModal').style.display = 'none';
            });
            
            // Channel edit
            document.getElementById('closeChannelEditBtn').addEventListener('click', () => {
                document.getElementById('channelEditModal').style.display = 'none';
                State.currentEditingChannel = null;
            });
            
            document.getElementById('saveChannelEditBtn').addEventListener('click', editChannel);
            
            // News
            document.getElementById('openNewsBtn').addEventListener('click', () => {
                document.getElementById('newsModal').style.display = 'flex';
                document.getElementById('newsBadge').classList.add('hidden');
            });
            
            document.getElementById('closeNewsBtn').addEventListener('click', () => {
                document.getElementById('newsModal').style.display = 'none';
            });
            
            document.getElementById('publishNewsBtn').addEventListener('click', publishNews);
            
            // Channels
            document.getElementById('openChannelBtn').addEventListener('click', () => {
                document.getElementById('channelModal').style.display = 'flex';
            });
            
            document.getElementById('closeChannelBtn').addEventListener('click', () => {
                document.getElementById('channelModal').style.display = 'none';
            });
            
            document.getElementById('createChannelBtn').addEventListener('click', createChannel);
            
            // Send message
            document.getElementById('sendButton').addEventListener('click', () => {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (State.currentChannel) {
                    sendChannelMessage(State.currentChannel.id, text);
                } else if (State.currentChatUser) {
                    if (isBlocked(State.currentChatUser.id)) {
                        showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                        return;
                    }
                    sendPrivateMessage(State.currentChatUser.id, text);
                }
                
                input.value = '';
            });
            
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const input = e.target;
                    const text = input.value.trim();
                    
                    if (State.currentChannel) {
                        sendChannelMessage(State.currentChannel.id, text);
                    } else if (State.currentChatUser) {
                        if (isBlocked(State.currentChatUser.id)) {
                            showNotification('❌ Этот пользователь заблокирован', 'Ошибка', 'error');
                            return;
                        }
                        sendPrivateMessage(State.currentChatUser.id, text);
                    }
                    
                    input.value = '';
                }
            });
            
            // Close modals on outside click
            window.addEventListener('click', (e) => {
                const settingsModal = document.getElementById('settingsModal');
                const channelModal = document.getElementById('channelModal');
                const channelEditModal = document.getElementById('channelEditModal');
                const channelProfileModal = document.getElementById('channelProfileModal');
                const newsModal = document.getElementById('newsModal');
                const profileModal = document.getElementById('userProfileModal');
                const stickerPanel = document.getElementById('stickerPanel');
                const stickerBtn = document.getElementById('stickerBtn');
                const searchResults = document.getElementById('searchResults');
                const searchInput = document.getElementById('searchInput');
                const channelSearchResults = document.getElementById('channelSearchResults');
                const channelSearchInput = document.getElementById('channelSearchInput');
                
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                
                if (e.target === channelModal) {
                    channelModal.style.display = 'none';
                }
                
                if (e.target === channelEditModal) {
                    channelEditModal.style.display = 'none';
                    State.currentEditingChannel = null;
                }
                
                if (e.target === channelProfileModal) {
                    channelProfileModal.style.display = 'none';
                }
                
                if (e.target === newsModal) {
                    newsModal.style.display = 'none';
                }
                
                if (e.target === profileModal) {
                    profileModal.style.display = 'none';
                }
                
                if (stickerPanel && stickerBtn) {
                    if (!stickerBtn.contains(e.target) && !stickerPanel.contains(e.target)) {
                        stickerPanel.classList.remove('visible');
                        stickerBtn.classList.remove('active');
                    }
                }
                
                if (searchResults && searchInput) {
                    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.classList.remove('visible');
                    }
                }
                
                if (channelSearchResults && channelSearchInput) {
                    if (!channelSearchInput.contains(e.target) && !channelSearchResults.contains(e.target)) {
                        channelSearchResults.classList.remove('visible');
                    }
                }
            });
            
            // Enter key for auth
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('regPasswordConfirm').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') register();
            });
        };

        // ========== INITIALIZATION ==========
        const init = () => {
            initEventListeners();
            initStickers();
            initOfficialChannel();
            loadChannels();
            loadNews();
            setupSearch();
            setupChannelSearch();
            
            // Check for saved session
            const savedUser = localStorage.getItem('signalwire_user');
            if (savedUser) {
                try {
                    State.currentUser = JSON.parse(savedUser);
                    database.ref('users/' + State.currentUser.id).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            State.currentUser = snapshot.val();
                            document.getElementById('authModal').style.display = 'none';
                            document.getElementById('app').style.display = 'flex';
                            document.getElementById('sidebar').classList.add('visible');
                            document.getElementById('chatContainer').style.display = 'flex';
                            
                            setTheme(State.currentUser.theme || 'dark');
                            updateUserCard();
                            loadUsers();
                            setupFirebaseListeners();
                            setupNotificationsListener();
                            setupIncomingMessagesListener();
                            
                            // Load blocked users
                            database.ref('blocked/' + State.currentUser.id).once('value', (snapshot) => {
                                const blocked = snapshot.val() || {};
                                Object.keys(blocked).forEach(id => State.blockedUsers.add(id));
                            });
                            
                            setTimeout(() => {
                                database.ref('channels/' + OFFICIAL_CHANNEL_ID).once('value', (snapshot) => {
                                    if (snapshot.exists()) {
                                        const channel = snapshot.val();
                                        State.subscribedChannels.add(OFFICIAL_CHANNEL_ID);
                                        renderMyChannels();
                                        joinChannel(OFFICIAL_CHANNEL_ID, channel);
                                    }
                                });
                            }, 1000);
                            
                            showNotification('🔌 Подключение восстановлено', 'SignalWire', 'success');
                        } else {
                            localStorage.removeItem('signalwire_user');
                        }
                    });
                } catch (e) {
                    localStorage.removeItem('signalwire_user');
                }
            }
        };

        // Start the application
        window.addEventListener('load', init);
    </script>
</body>
</html>
